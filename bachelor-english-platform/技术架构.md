# 技术架构

## 🏗️ 系统架构概述

### 高层架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端          │    │   后端API       │    │   数据库        │
│   (Next.js)     │◄──►│   (Express.js)  │◄──►│   (MySQL)       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   CDN/静态      │    │   缓存层        │    │   文件存储      │
│   (Vercel)      │    │   (Redis)       │    │   (AWS S3)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 🎨 前端架构

### 技术栈
- **框架**: Next.js 14 with App Router
- **语言**: TypeScript
- **样式**: Tailwind CSS + Ant Design
- **状态管理**: Zustand + React Query
- **UI组件**: Ant Design (主要)
- **图标**: Ant Design Icons + Lucide React
- **动画**: Framer Motion
- **测试**: Jest + React Testing Library

### 项目结构
```
frontend/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── (auth)/            # 认证路由组
│   │   ├── (dashboard)/       # 仪表板路由组
│   │   ├── globals.css        # 全局样式
│   │   ├── layout.tsx         # 根布局
│   │   └── page.tsx           # 首页
│   ├── components/            # 可重用组件
│   │   ├── ui/               # 基础UI组件
│   │   ├── forms/            # 表单组件
│   │   ├── learning/         # 学习特定组件
│   │   └── layout/           # 布局组件
│   ├── hooks/                # 自定义React钩子
│   ├── lib/                  # 工具函数
│   ├── stores/               # Zustand存储
│   ├── types/                # TypeScript类型定义
│   └── utils/                # 辅助函数
├── public/                   # 静态资源
├── tailwind.config.js        # Tailwind配置
├── next.config.js           # Next.js配置
└── package.json
```

### 组件架构
```typescript
// 组件层次结构示例
App
├── Layout
│   ├── Header
│   ├── Sidebar
│   └── Footer
├── AuthProvider
├── ThemeProvider
└── Routes
    ├── HomePage
    ├── LearningCenter
    │   ├── VocabularyModule
    │   ├── GrammarModule
    │   ├── ReadingModule
    │   ├── WritingModule
    │   └── TranslationModule
    └── Dashboard
        ├── ProgressOverview
        ├── Analytics
        └── Settings
```

### 状态管理策略
```typescript
// Zustand存储
interface AppState {
  user: User | null;
  theme: 'light' | 'dark';
  sidebarCollapsed: boolean;
}

interface LearningState {
  currentModule: string;
  progress: ProgressData;
  achievements: Achievement[];
}

// React Query用于服务器状态
const useVocabulary = (level: string) => {
  return useQuery({
    queryKey: ['vocabulary', level],
    queryFn: () => fetchVocabulary(level),
    staleTime: 5 * 60 * 1000, // 5分钟
  });
};
```

### Ant Design集成
```typescript
// 主题配置
const theme = {
  token: {
    colorPrimary: '#1890ff',
    borderRadius: 6,
    fontSize: 14,
  },
  components: {
    Button: {
      borderRadius: 6,
    },
    Card: {
      borderRadius: 8,
    },
  },
};

// 使用Ant Design的自定义组件
const WordCard: React.FC<WordCardProps> = ({ word }) => {
  return (
    <Card className="word-card">
      <Card.Meta
        title={word.word}
        description={word.pronunciation}
      />
      <Button type="primary" onClick={handleFlip}>
        显示含义
      </Button>
    </Card>
  );
};
```

## 🔧 后端架构

### 技术栈
- **运行时**: Node.js 18+
- **框架**: Express.js
- **语言**: TypeScript
- **ORM**: Prisma
- **数据库**: MySQL 8.0
- **缓存**: Redis 7
- **认证**: JWT + Passport.js
- **验证**: Zod
- **测试**: Jest + Supertest

### 项目结构
```
backend/
├── src/
│   ├── controllers/          # 请求处理器
│   │   ├── auth.controller.ts
│   │   ├── user.controller.ts
│   │   ├── vocabulary.controller.ts
│   │   └── learning.controller.ts
│   ├── services/            # 业务逻辑
│   │   ├── auth.service.ts
│   │   ├── user.service.ts
│   │   ├── vocabulary.service.ts
│   │   └── learning.service.ts
│   ├── models/              # 数据模型
│   │   ├── user.model.ts
│   │   ├── vocabulary.model.ts
│   │   └── progress.model.ts
│   ├── routes/              # API路由
│   │   ├── auth.routes.ts
│   │   ├── user.routes.ts
│   │   ├── vocabulary.routes.ts
│   │   └── learning.routes.ts
│   ├── middleware/          # Express中间件
│   │   ├── auth.middleware.ts
│   │   ├── validation.middleware.ts
│   │   └── error.middleware.ts
│   ├── utils/               # 工具函数
│   │   ├── database.ts
│   │   ├── redis.ts
│   │   └── helpers.ts
│   └── types/               # TypeScript类型
│       ├── auth.types.ts
│       ├── user.types.ts
│       └── learning.types.ts
├── prisma/
│   ├── schema.prisma        # 数据库模式
│   ├── migrations/          # 数据库迁移
│   └── seed.ts              # 种子数据
├── tests/                   # 测试文件
├── .env.example            # 环境变量示例
└── package.json
```

### API设计
```typescript
// RESTful API结构
/api/v1
├── /auth
│   ├── POST /register
│   ├── POST /login
│   ├── POST /logout
│   ├── POST /refresh
│   └── POST /forgot-password
├── /users
│   ├── GET /profile
│   ├── PUT /profile
│   ├── GET /progress
│   └── GET /achievements
├── /vocabulary
│   ├── GET /words
│   ├── GET /words/:id
│   ├── POST /study
│   ├── GET /review
│   └── POST /test
├── /grammar
│   ├── GET /lessons
│   ├── GET /exercises
│   └── POST /submit
├── /reading
│   ├── GET /passages
│   ├── GET /questions
│   └── POST /answers
├── /writing
│   ├── POST /submit
│   ├── GET /feedback
│   └── GET /templates
├── /translation
│   ├── GET /exercises
│   └── POST /submit
└── /analytics
    ├── GET /progress
    ├── GET /performance
    └── GET /recommendations
```

### 数据库模式
```prisma
// Prisma模式示例 (MySQL)
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  password  String
  avatar    String?
  level     String   @default("beginner")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关系
  progress     LearningProgress[]
  vocabulary   UserVocabulary[]
  achievements Achievement[]
  testRecords  TestRecord[]

  @@map("users")
}

model Vocabulary {
  id            String  @id @default(cuid())
  word          String  @unique
  pronunciation String?
  meaning       String
  partOfSpeech  String?
  difficulty    Int     @default(1)
  examples      Json?
  audioUrl      String?
  createdAt     DateTime @default(now())

  // 关系
  userVocabulary UserVocabulary[]

  @@map("vocabulary")
}

model UserVocabulary {
  id            String     @id @default(cuid())
  userId        String
  vocabularyId  String
  masteryLevel  Int        @default(0)
  reviewCount   Int        @default(0)
  lastReviewed  DateTime?
  nextReview    DateTime?
  createdAt     DateTime   @default(now())

  // 关系
  user      User      @relation(fields: [userId], references: [id])
  vocabulary Vocabulary @relation(fields: [vocabularyId], references: [id])

  @@unique([userId, vocabularyId])
  @@map("user_vocabulary")
}
```

## 🗄️ 数据库架构

### 数据库设计原则
- **规范化**: 适当的数据库规范化
- **索引**: 性能的战略性索引
- **关系**: 清晰的外键关系
- **约束**: 数据完整性约束
- **迁移**: 版本控制的模式更改

### 核心表
```sql
-- 用户和认证
users
user_sessions
user_profiles

-- 学习内容
vocabulary
grammar_lessons
reading_passages
writing_prompts
translation_exercises

-- 学习进度
learning_progress
user_vocabulary
user_achievements
test_records

-- 社交功能
study_groups
discussions
user_follows
```

### 性能优化
```sql
-- 性能索引
CREATE INDEX idx_user_email ON users(email);
CREATE INDEX idx_vocabulary_difficulty ON vocabulary(difficulty);
CREATE INDEX idx_user_vocabulary_user_id ON user_vocabulary(user_id);
CREATE INDEX idx_user_vocabulary_next_review ON user_vocabulary(next_review);

-- 复合索引
CREATE INDEX idx_user_progress_module ON learning_progress(user_id, module_type);
CREATE INDEX idx_test_records_user_date ON test_records(user_id, completed_at);
```

## 🔐 安全架构

### 认证与授权
```typescript
// JWT认证
interface JWTPayload {
  userId: string;
  email: string;
  role: string;
  iat: number;
  exp: number;
}

// 基于角色的访问控制
enum UserRole {
  STUDENT = 'student',
  TEACHER = 'teacher',
  ADMIN = 'admin'
}

// 受保护路由的中间件
const authenticateToken = (req: Request, res: Response, next: NextFunction) => {
  const token = req.headers.authorization?.split(' ')[1];
  
  if (!token) {
    return res.status(401).json({ error: '需要访问令牌' });
  }
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET!) as JWTPayload;
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(403).json({ error: '无效令牌' });
  }
};
```

### 数据验证
```typescript
// Zod验证模式
const registerSchema = z.object({
  email: z.string().email(),
  username: z.string().min(3).max(20),
  password: z.string().min(8),
  confirmPassword: z.string()
}).refine((data) => data.password === data.confirmPassword, {
  message: "密码不匹配",
  path: ["confirmPassword"],
});

const vocabularySchema = z.object({
  word: z.string().min(1),
  meaning: z.string().min(1),
  pronunciation: z.string().optional(),
  partOfSpeech: z.string().optional(),
  difficulty: z.number().min(1).max(5),
  examples: z.array(z.object({
    sentence: z.string(),
    translation: z.string()
  })).optional()
});
```

## 🚀 部署架构

### 前端部署 (Vercel)
```yaml
# vercel.json
{
  "framework": "nextjs",
  "buildCommand": "npm run build",
  "outputDirectory": ".next",
  "installCommand": "npm install",
  "devCommand": "npm run dev",
  "env": {
    "NEXT_PUBLIC_API_URL": "@api-url",
    "NEXT_PUBLIC_APP_URL": "@app-url"
  }
}
```

### 后端部署 (Railway)
```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3001

CMD ["npm", "start"]
```

### 环境配置
```bash
# .env.production
NODE_ENV=production
PORT=3001
DATABASE_URL=mysql://user:password@host:port/database
REDIS_URL=redis://host:port
JWT_SECRET=your-jwt-secret
API_URL=https://api.bachelor-english-platform.com
FRONTEND_URL=https://bachelor-english-platform.com
```

## 📊 监控与分析

### 应用监控
```typescript
// Sentry集成
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 1.0,
});

// 自定义错误跟踪
const trackError = (error: Error, context: any) => {
  Sentry.captureException(error, {
    tags: {
      component: context.component,
      action: context.action,
    },
    extra: context,
  });
};
```

### 性能监控
```typescript
// 性能跟踪
const trackPerformance = (metric: string, value: number) => {
  // 发送到分析服务
  analytics.track('performance_metric', {
    metric,
    value,
    timestamp: Date.now(),
  });
};

// API响应时间跟踪
app.use((req, res, next) => {
  const start = Date.now();
  
  res.on('finish', () => {
    const duration = Date.now() - start;
    trackPerformance('api_response_time', duration);
  });
  
  next();
});
```

## 🔄 CI/CD管道

### GitHub Actions工作流
```yaml
# .github/workflows/deploy.yml
name: 部署到生产环境

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run test
      - run: npm run lint

  deploy-frontend:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}

  deploy-backend:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: railway-app/railway-deploy@v1
        with:
          railway-token: ${{ secrets.RAILWAY_TOKEN }}
```

## 📱 移动端与PWA支持

### 渐进式Web应用
```typescript
// next.config.js
const withPWA = require('next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
});

module.exports = withPWA({
  // Next.js配置
});

// 服务工作者
self.addEventListener('fetch', (event) => {
  if (event.request.url.includes('/api/')) {
    event.respondWith(
      fetch(event.request).catch(() => {
        return new Response('离线', { status: 503 });
      })
    );
  }
});
```

### 响应式设计
```css
/* 移动优先方法 */
.word-card {
  @apply w-full p-4;
}

@media (min-width: 768px) {
  .word-card {
    @apply w-1/2 p-6;
  }
}

@media (min-width: 1024px) {
  .word-card {
    @apply w-1/3 p-8;
  }
}
```

---

*此技术架构为构建可扩展、可维护和高性能的学位英语学习平台提供了坚实基础。*
